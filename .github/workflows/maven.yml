name: Publish to GitHub Packages

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Configure Maven settings for GitHub Packages
      run: |
        mkdir -p ~/.m2
        cat > ~/.m2/settings.xml << 'EOF'
        <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                      http://maven.apache.org/xsd/settings-1.0.0.xsd">
          <servers>
            <server>
              <id>github</id>
              <username>${{ github.actor }}</username>
              <password>${{ secrets.GITHUB_TOKEN }}</password>
            </server>
          </servers>
        </settings>
        EOF
        echo "‚úÖ Maven settings configured"
    
    - name: Get current version and commit hash
      id: vars
      run: |
        # Obtener versi√≥n actual del pom.xml
        CURRENT_VERSION=$(grep -oP '(?<=<version>).*(?=</version>)' pom.xml | head -1)
        # Obtener hash del commit corto
        COMMIT_SHORT=$(git rev-parse --short HEAD)
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_ENV
        echo "commit_short=$COMMIT_SHORT" >> $GITHUB_ENV
        echo "üìã Current version: $CURRENT_VERSION"
        echo "üîó Commit hash: $COMMIT_SHORT"
    
    - name: Create unique deployment version
      id: unique_version
      run: |
        # Crear versi√≥n √∫nica para evitar conflictos 409
        TIMESTAMP=$(date +%Y%m%d%H%M%S)
        UNIQUE_VERSION="${CURRENT_VERSION}.${TIMESTAMP}-${COMMIT_SHORT}"
        echo "unique_version=$UNIQUE_VERSION" >> $GITHUB_ENV
        echo "üéØ Unique deployment version: $UNIQUE_VERSION"
    
    - name: Create temporary pom.xml with unique version
      run: |
        # Crear un pom.xml temporal con la versi√≥n √∫nica
        # Usamos .tmp para no modificar el original
        cp pom.xml pom.xml.original
        sed -i "s|<version>${CURRENT_VERSION}</version>|<version>${UNIQUE_VERSION}</version>|" pom.xml
        echo "üìÑ Created temporary pom.xml with version: $UNIQUE_VERSION"
    
    - name: Build and Deploy with unique version
      run: |
        echo "üöÄ Building and deploying version: $UNIQUE_VERSION"
        
        # 1. Primero hacer clean y package con la versi√≥n √∫nica
        mvn clean package -DskipTests
        
        # 2. Luego hacer deploy con la versi√≥n √∫nica
        mvn deploy -DskipTests \
          -DaltDeploymentRepository=github::default::https://maven.pkg.github.com/CUPUL-MIU-04/Revoid-jadb
        
        echo "‚úÖ Successfully deployed version: $UNIQUE_VERSION"
    
    - name: Restore original pom.xml
      run: |
        # Restaurar el pom.xml original
        mv pom.xml.original pom.xml
        echo "üîÑ Restored original pom.xml with version: $CURRENT_VERSION"
    
    - name: Verify deployment
      run: |
        echo "üéâ Deployment completed successfully!"
        echo "üì¶ Package URL: https://github.com/CUPUL-MIU-04/Revoid-jadb/packages"
        echo "üè∑Ô∏è  Version deployed: $UNIQUE_VERSION"
