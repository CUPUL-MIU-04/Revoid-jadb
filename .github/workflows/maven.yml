name: Publish to GitHub Packages

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Generate unique deploy version
      id: version
      run: |
        # Usar un formato de versiÃ³n Maven vÃ¡lido para deploy
        # Formato: major.minor.patch-qualifier (el guion es importante)
        TIMESTAMP=$(date +%Y%m%d%H%M%S)
        COMMIT_SHORT=$(git rev-parse --short HEAD)
        # VersiÃ³n con formato Maven vÃ¡lido: 1.2.1-20251203131321-4faea77
        UNIQUE_VERSION="1.2.1-$TIMESTAMP-$COMMIT_SHORT"
        echo "unique_version=$UNIQUE_VERSION" >> $GITHUB_OUTPUT
        echo "VersiÃ³n Ãºnica para deploy: $UNIQUE_VERSION"
    
    - name: Configure Maven settings
      run: |
        mkdir -p ~/.m2
        cat > ~/.m2/settings.xml << 'EOF'
        <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                      http://maven.apache.org/xsd/settings-1.0.0.xsd">
          <servers>
            <server>
              <id>github</id>
              <username>${{ github.actor }}</username>
              <password>${{ secrets.GITHUB_TOKEN }}</password>
            </server>
          </servers>
        </settings>
        EOF
    
    - name: Deploy with unique version using altDeploymentRepository
      run: |
        echo "ðŸ”¨ Publicando versiÃ³n: ${{ steps.version.outputs.unique_version }}"
        
        # PRIMERO: Construir con la versiÃ³n normal del pom.xml
        mvn clean compile -DskipTests
        
        # SEGUNDO: Hacer deploy con versiÃ³n personalizada SIN modificar pom.xml
        mvn deploy:deploy-file \
          -Durl=https://maven.pkg.github.com/CUPUL-MIU-04/Revoid-jadb \
          -DrepositoryId=github \
          -Dfile=target/jadb-1.2.1.3.jar \
          -Dsources=target/jadb-1.2.1.3-sources.jar \
          -DpomFile=pom.xml \
          -DgroupId=com.revoid \
          -DartifactId=jadb \
          -Dversion=${{ steps.version.outputs.unique_version }} \
          -DskipTests
        
        echo "âœ… Â¡PublicaciÃ³n exitosa!"
