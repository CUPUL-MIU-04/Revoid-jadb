name: Publish to GitHub Packages

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Configure Maven settings for GitHub Packages
      run: |
        mkdir -p ~/.m2
        cat > ~/.m2/settings.xml << 'EOF'
        <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                      http://maven.apache.org/xsd/settings-1.0.0.xsd">
          <servers>
            <server>
              <id>github</id>
              <username>${{ github.actor }}</username>
              <password>${{ secrets.GITHUB_TOKEN }}</password>
            </server>
          </servers>
        </settings>
        EOF
        echo "âœ… Maven settings configured"
    
    - name: Extract current version and generate unique version
      id: version_info
      run: |
        # Extraer versiÃ³n actual del pom.xml
        CURRENT_VERSION=$(grep -oP '(?<=<version>).*(?=</version>)' pom.xml | head -1)
        echo "VersiÃ³n actual en pom.xml: $CURRENT_VERSION"
        
        # Obtener hash del commit corto
        COMMIT_SHORT=$(git rev-parse --short HEAD)
        echo "Commit SHA corto: $COMMIT_SHORT"
        
        # Crear timestamp
        TIMESTAMP=$(date +%Y%m%d%H%M%S)
        echo "Timestamp: $TIMESTAMP"
        
        # Crear versiÃ³n Ãºnica CORRECTAMENTE
        UNIQUE_VERSION="${CURRENT_VERSION}.${TIMESTAMP}-${COMMIT_SHORT}"
        echo "VersiÃ³n Ãºnica generada: $UNIQUE_VERSION"
        
        # Guardar en output del step
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "unique_version=$UNIQUE_VERSION" >> $GITHUB_OUTPUT
        
        # TambiÃ©n exportar como variable de entorno para pasos siguientes
        echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
        echo "UNIQUE_VERSION=$UNIQUE_VERSION" >> $GITHUB_ENV
    
    - name: Debug variables
      run: |
        echo "DEBUG - VersiÃ³n actual: ${{ steps.version_info.outputs.current_version }}"
        echo "DEBUG - VersiÃ³n Ãºnica: ${{ steps.version_info.outputs.unique_version }}"
        echo "DEBUG - ENV VersiÃ³n actual: $CURRENT_VERSION"
        echo "DEBUG - ENV VersiÃ³n Ãºnica: $UNIQUE_VERSION"
    
    - name: Create temporary pom.xml with unique version
      run: |
        echo "Creando pom.xml temporal con versiÃ³n Ãºnica..."
        echo "VersiÃ³n original: ${{ steps.version_info.outputs.current_version }}"
        echo "VersiÃ³n Ãºnica: ${{ steps.version_info.outputs.unique_version }}"
        
        # Crear backup
        cp pom.xml pom.xml.backup
        
        # Actualizar versiÃ³n en pom.xml (usando un delimitador diferente)
        sed -i.bak "s#<version>${{ steps.version_info.outputs.current_version }}</version>#<version>${{ steps.version_info.outputs.unique_version }}</version>#" pom.xml
        
        # Verificar el cambio
        echo "Contenido actual de pom.xml (primeras 5 lÃ­neas):"
        head -20 pom.xml | grep -A2 -B2 "<version>"
    
    - name: Build with unique version
      run: |
        echo "ðŸš€ Construyendo con versiÃ³n Ãºnica: ${{ steps.version_info.outputs.unique_version }}"
        mvn clean compile -DskipTests
        echo "âœ… Build completado"
    
    - name: Deploy with unique version
      run: |
        echo "ðŸ“¦ Desplegando versiÃ³n: ${{ steps.version_info.outputs.unique_version }}"
        
        # Deploy usando la versiÃ³n Ãºnica
        mvn deploy -DskipTests \
          -DaltDeploymentRepository=github::https://maven.pkg.github.com/CUPUL-MIU-04/Revoid-jadb
        
        echo "âœ… Â¡Deploy exitoso!"
    
    - name: Restore original pom.xml
      if: always()
      run: |
        echo "ðŸ”„ Restaurando pom.xml original..."
        mv pom.xml.backup pom.xml
        echo "âœ… pom.xml restaurado a versiÃ³n: ${{ steps.version_info.outputs.current_version }}"
    
    - name: Verify deployment
      if: success()
      run: |
        echo "ðŸŽ‰ Â¡Despliegue completado exitosamente!"
        echo "ðŸ“Š VersiÃ³n desplegada: ${{ steps.version_info.outputs.unique_version }}"
        echo "ðŸ”— URL del paquete: https://github.com/CUPUL-MIU-04/Revoid-jadb/packages"
